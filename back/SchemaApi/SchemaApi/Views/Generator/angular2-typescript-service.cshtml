@using Microsoft.AspNetCore.Mvc.ApiExplorer;
@using SchemaApi.Helpers;
@using SchemaApi.Models.Generators;
@model IApiDescriptionGroupCollectionProvider
@{

    var template = new RazorHelperTypescript(this);
    TypeDiscoverRepository repository = new TypeDiscoverRepository(Model);

    /* tslint:disable:no-unused-variable member-ordering */


    foreach (ApiDescriptionGroup group in Model.ApiDescriptionGroups.Items)
    {

        string name = group.GroupName.Replace("Controller", "");
        string targetPath = $"Shared\\{name}\\{name}service.ts";

        template.AddStartComment();
        template.AddCommentLine("NOTE: This class is auto generated by the template angular2-typescript-service.cshtml.");
        template.AddCommentLine("Do not edit the class manually.");
        template.AddEndComment();
        template.AddEmpty();

        // Imports
        HashSet<Type> _types = new HashSet<Type>();

        foreach (ApiDescription api in group.Items)
        {
            foreach (ApiParameterDescription p in api.ParameterDescriptions)
            {
                repository.FindTypeToImport(p.Type, _types);
            }

            foreach (ApiResponseType response in api.SupportedResponseTypes)
            {
                repository.FindTypeToImport(response.Type, _types);
            }
        }

        template.AddImport("Inject, Injectable, Optional", "@angular/core");
        template.AddImport("Http, Headers, URLSearchParams", "@angular/http");
        template.AddImport("RequestMethod, RequestOptions, RequestOptionsArgs", "@angular/http");
        template.AddImport("Response, ResponseContentType", "@angular/http");
        template.AddImport("Observable", "rxjs/Observable");
        template.AddImport("BASE_PATH", "../variables");
        template.AddImport("Configuration", PathBuilderHelper.GetRelativePath(System.IO.Path.Combine(@"c:\app", targetPath), "c:\\app\\shared\\configuration.model.ts"));

        foreach (var item in _types)
        {
            string txt = $"Shared\\{item.Namespace.Replace(".", "\\")}\\{item.Name}.ts";
            string _path = PathBuilderHelper.GetRelativePath(System.IO.Path.Combine(@"c:\app", targetPath), System.IO.Path.Combine(@"c:\app", txt));
            template.AddImport(template.WriteType(item), _path.Substring(0, _path.Length - 3));
        }

        template.AddEmpty();


        template.Add("@Injectable()");
        using (var t = template.AddExportedClass(name, "I" + name))
        {

            template.AddProperty("basePath", "string", RazorHelperTypescript.ExpositionEnum.Protected, "'http://petstore.swagger.io/v2'");
            template.AddProperty("defaultHeaders", "Headers", RazorHelperTypescript.ExpositionEnum.Public, "new Headers()");
            template.AddProperty("configuration", "Configuration", RazorHelperTypescript.ExpositionEnum.Public, "new Configuration()");

            using (var m = template.AddMethod("constructor", null, new List<KeyValuePair<string, string>>()
            {
                new KeyValuePair<string, string>("protected http", "Http"),
                new KeyValuePair<string, string>("@Optional() @Inject(BASE_PATH) basePath", "string"),
                new KeyValuePair<string, string>("@Optional() configuration", "Configuration"),
            }))
            {
                using (template.AddIf("basePath"))
                {
                    template.AddLine("this.basePath = basePath;");
                }
                using (template.AddIf("configuration"))
                {
                    template.AddLine("this.configuration = configuration;");
                }
            }
            template.AddEmpty();

            template.Add(@"    /**
    *
    * Extends object by coping non-existing properties.
    * @@param objA object to be extended
    * @@param objB source object
    */
    private extendObj<T1, T2>
        (objA: T1, objB: T2) {
        for (let key in objB) {
            if (objB.hasOwnProperty(key)) {
                (objA as any)[key] = (objB as any)[key];
            }
        }
        return <T1 & T2>
            objA;
    }

    /**
    * @@param consumes string[] mime-types
    * @@return true: consumes contains 'multipart/form-data', false: otherwise
    */
    private canConsumeForm(consumes: string[]): boolean {
        const form = 'multipart/form-data';
        for (let consume of consumes) {
            if (form === consume) {
                return true;
            }
        }
        return false;
    }

");

            foreach (ApiDescription api in group.Items)
            {

                var nn = api.ActionDescriptor.DisplayName.Split('(')[0].Split('.');
                string methodName = nn[nn.Length - 1].Trim();

                var parameters = new List<KeyValuePair<string, string>>();

                foreach (ApiParameterDescription p in api.ParameterDescriptions)
                {
                    parameters.Add(new KeyValuePair<string, string>(p.Name, template.WriteType(p.Type)));
                }

                string resultType = "Observable<{}>";
                foreach (ApiResponseType response in api.SupportedResponseTypes)
                {
                    resultType = $"Observable<{template.WriteType(response.Type)}>";
                }

                using (var m = template.AddMethod(methodName, resultType, parameters, RazorHelperTypescript.ExpositionEnum.Public))
                {
                    template.AddLine($"return this.{methodName}_WithHttpInfo({string.Join(", ", parameters.Select(c => c.Key))})");
                    using (template.AddBlock(".map((response: Response) => "))
                    {

                        using (template.AddIf("response.status === 204"))
                        {
                            template.AddLine("return undefined;");
                        }

                        using (template.AddElse())
                        {
                            template.AddLine("return response.json() || { };");
                        }
                    }
                    template.AddLine(");");
                }
                template.AddEmpty();

                parameters.Add(new KeyValuePair<string, string>("extraHttpRequestParams?", "any"));
                using (var m = template.AddMethod($"{methodName}_WithHttpInfo", "Observable<Response>", parameters, RazorHelperTypescript.ExpositionEnum.Private))
                {
                    template.AddEmpty();
                    template.AddLine($"const path = this.basePath + '/{api.RelativePath}';");

                    template.AddEmpty();
                    template.AddLine($"let queryParameters = new URLSearchParams();");
                    template.AddLine($"let headers = new Headers(this.defaultHeaders.toJSON()); // https://github.com/angular/angular/issues/6845");

                    foreach (ApiParameterDescription p in api.ParameterDescriptions)
                    {
                        template.AddEmpty();

                        if (p.ModelMetadata.IsRequired)
                        {
                            using (template.AddIf($"{p.Name} === null || {p.Name} === undefined"))
                            {
                                template.AddLine($"throw new Error('Required parameter {p.Name} was null or undefined when calling {methodName}.');");
                            }
                        }

                    }

                    template.AddLine("// to determine the Accept header");
                    template.AddLine($"let produces: string[] = [ 'application/xml', 'application/json' ];");

                    foreach (ApiParameterDescription p in api.ParameterDescriptions)
                    {

                        using (template.AddIf($"{p.Name} !== undefined"))
                        {
                            template.AddLine($"queryParameters.set('{p.Name}', <any> {p.Name});");
                        }
                    }

                    template.AddLine($"headers.set('Content-Type', 'application/json');");

                    template.AddEmpty();
                    template.AddLine("let requestOptions: RequestOptionsArgs = new RequestOptions({");

                    template.AddLine(" headers: headers,");
                    bool withBody = false;
                    switch (api.HttpMethod)
                    {
                        case "GET":
                            template.AddLine(" method: RequestMethod.Get,");
                            template.AddLine(" body:'',");
                            break;

                        case "POST":
                            template.AddLine(" method: RequestMethod.Post,");
                            template.AddLine(" body: body == null ? '' : JSON.stringify(body), // https://github.com/angular/angular/issues/10612");
                            withBody = true;
                            break;

                        case "PUT":
                            template.AddLine(" method: RequestMethod.Put,");
                            template.AddLine(" body: body == null ? '' : JSON.stringify(body), // https://github.com/angular/angular/issues/10612");
                            withBody = true;
                            break;

                        case "DELETE":
                            template.AddLine(" method: RequestMethod.Delete,");
                            template.AddLine(" body: '',");
                            break;

                        case "HEAD":
                            template.AddLine(" method: RequestMethod.Head,");
                            template.AddLine(" body: '',");
                            break;

                        case "OPTIONS":
                            template.AddLine($" method: RequestMethod.Options,");
                            template.AddLine(" body: '',");
                            break;

                        case "PATCH":
                            template.AddLine(" method: RequestMethod.Patch,");
                            template.AddLine(" body: '',");
                            break;

                    }
                    template.AddLine(" search: queryParameters,");
                    template.AddLine(" withCredentials: this.configuration.withCredentials");
                    template.AddLine("});");

                    template.AddEmpty();
                    using (template.AddIf($"extraHttpRequestParams"))
                    {
                        template.AddLine($"requestOptions = (<any>Object).assign(requestOptions, extraHttpRequestParams);");
                    }

                    template.AddLine("return this.http.request(path, requestOptions);");

                }

                template.AddEmpty();

            }

        }

        template.CutFile(targetPath);

    }

}
